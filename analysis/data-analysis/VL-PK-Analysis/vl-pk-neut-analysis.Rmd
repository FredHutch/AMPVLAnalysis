---
title: "PK, Neutralization, and VL - Descriptive analysis"
author: "Bryan Mayer"
date: "`r Sys.Date()`"
output: html_document
---

This has some odds and ends analysis for PK, neut, and VL. Dan has developed the dose-response models for first positive.

The main question here is the relationship of first positive to time of infection and last infusion. This depends on having the infection time estimated from the VL model analysis.

Basically, at time of infection, the titer is make or break on protection. The threshold identified for protection here is a PT80 in the 300 range. However, for VL modulation, we find the titer must be higher. The paradox is, if higher titers prevention infection vs. modulation, how do we have post-acquisition titers high enough to modulate VL. The AMP study does have post-exposure infusions though that could explain.

From the data, one approach is assess titers at infection vs. titers near first positive. If post-exposure infusion explains modulation, we would expect maybe higher titers near first positive. This is challenging though because there is lag effect: high titers suppress VL prior to first positive and the first positive may be lower because of higher titers prior to the measurement vs. simultaneously with measurement. Titers are subject to PK, with non-linear effects on VL that are unobserved compounded by sparse sampling.

 - Tally cases of infusions between infection time and first positive
 - Duration duration from previous infusion to first positive, vs. first positive.

A model-based approach: Re-simulate PKPD-V in VRC01 participants stopping VRC01 at infection time. Then predict VL at the first positive measurement time to compare with the observed first positive.

```{r}
library(tidyverse)
library(here)
library(glue)
library(kableExtra)
library(cowplot)
library(janitor)
library(cowplot)
library(GGally)
library(knitr)
source(here("R", "directory-funs.R"))
source(here("R", "rxode-funs.R"))
source(here("R", "mlx-res-processing.R"))
source(here("models", "rxode-models", "rxode-pkpd-models.R"))
theme_set(theme_bw())


vl_data = read_csv(clean_data_here("adata-vl-stats.csv"), col_types = cols()) 

vrc01_dose = read_csv(mlx_data_here("amp-mlx-pkpd-indirect-holteT0.csv"), col_types = cols()) %>%
  filter(ADM == 1) %>%
  distinct(pub_id, TIME, AMT, RATE) %>%
  mutate(AMT = as.numeric(AMT), RATE = as.numeric(RATE)) %>%
  arrange(pub_id, TIME) %>%
  group_by(pub_id) %>%
  mutate(DOSENO = row_number()) %>%
  ungroup()

vl_mod_summary_all = read_csv(clean_data_here("final_vl_summary.csv"), col_types = cols()) 

vl_mod_vrc01 = vl_mod_summary_all %>% filter(rx_code2 != "C")
vl_mod_placebo = vl_mod_summary_all %>% filter(rx_code2 == "C")

vl_mod_vrc01_pred_raw =  get_indiv_preds("PKPD/adj-pkpd-model-no-omega") %>%
  rename(pub_id = ID)

vl_mod_vrc01_preds = vl_mod_vrc01_pred_raw %>%
  left_join(select(vl_mod_vrc01, pub_id, fp_day), by = "pub_id") %>%
  filter(time == fp_day) %>%
  mutate(first_pos_ipred = log10(indivPredMode)) %>%
  select(pub_id, first_pos_ipred)

pk_sim_pre_fp = read_csv(here("output/pk-modeling/sim-pk-withVLneut.csv"), col_types = cols()) %>%
  filter(days_enrollment <= fp_day) %>%
  left_join(select(vl_mod_vrc01, pub_id, model_infection_day), by = "pub_id") %>%
  mutate(pt80 = centr_conc/gmt80ls, sens = gmt80ls <= 1)

# 2 vrc01 ptids only have first positive, werent in model
stopifnot(nrow(subset(pk_sim_pre_fp, round(model_infection_day) == days_enrollment)) == 96)

```

## Counter-factual FP modeling

Turning off VRC01 altogether explains some of the reduction in VL but not all of it.

```{r}
vl_mod_vrc01_pred_raw %>%
  ggplot(aes(x = log10(indivPredMode), y = log10(DV))) +
  geom_point() +
  geom_abline()


```

```{r}

vl_sims_infection_stop = map_df(1:nrow(filter(vl_mod_vrc01, vl_model_flag)), function(i){
  parm_set = vl_mod_vrc01[i, ]
  stopifnot(nrow(parm_set) == 1)
  infection_day = parm_set$model_infection_day
  fp_day = parm_set$fp_day
  
  ptid_days = filter(vl_data, pub_id == parm_set$pub_id &
                       days_enrollment >= infection_day & days_enrollment <= fp_day) %>%
    pull(days_enrollment)
  
  stopifnot(fp_day %in% ptid_days)

  # no dosing after transmission
  dosing = filter(vrc01_dose, pub_id == parm_set$pub_id)
  dosing_stop = filter(dosing, TIME < infection_day)
  dosing_none = NULL
  if(nrow(dosing) == 0) dosing = NULL
  if(nrow(dosing_stop) == 0) dosing_stop = NULL
  
  # this first mtime for future work, but needed to git the old method
  #mtime = c(0, ptid_days)
  mtime = c(0, fp_day)
  
  theta_pk = select(parm_set, Cl, V1, Q, V2)
  theta_pd = tibble(IC80 = parm_set$gmt50ls * 4 ^(1/parm_set$hill_ls), 
                    rho = 10^parm_set$lrho_mode, 
                    h = parm_set$hill_ls)
  run_mod = function(dose_in){
      run_pkpd_models(mtime,      
                  holte_pkpd_model,
                  theta_pk = theta_pk,
                  theta_vl = prep_vl_model_parms(mode_parms = parm_set),
                  theta_pd = theta_pd,
                  infection_time = infection_day,
                  infusion_pk_dosing = dose_in) %>% filter(time > 0)
  }
  parm_set %>%
  mutate(
    first_pos_mod = run_mod(dosing)$log10V,
    first_pos_counter = run_mod(dosing_stop)$log10V,
    first_pos_novrc01 = run_mod(dosing_none)$log10V,
    model = "first_pos")
}) %>%
  left_join(vl_mod_vrc01_preds, by = "pub_id")

# confirmed that ipred = pos_mod

```

```{r}

vl_sims_infection_stop %>%
  select(first_pos, first_pos_mod, first_pos_counter, first_pos_novrc01) %>%
  ggpairs()

```

```{r}

vl_sims_infection_stop %>%
  mutate(sens = gmt80ls < 1) %>%
  gather(source, first_pos, first_pos_mod, first_pos_novrc01) %>%
  ggplot(aes(x = source, y = first_pos)) +
  geom_boxplot() +
  geom_point() +
  geom_path(aes(group = pub_id), alpha = 0.5) +
  geom_text(data = mutate(subset(vl_sims_infection_stop, pub_id %in% c("704-0592", "704-0893")),
                          sens = gmt80ls < 1),
            x = 1, aes(y =first_pos_mod, label = pub_id)) +
  facet_wrap(~sens, labeller = 
               as_labeller(c(`FALSE` = "IC80 > 1",
                             `TRUE` = "IC80 < 1"))
  )

```

## Looking at data

Is this a dead-end.

# Look at the data among sensitive viruses.

```{r}
pk_sim_pre_fp %>%
  filter(gmt80ls <= 1 & (days_enrollment - fp_day) < 60) %>%
  ggplot(aes(x = (days_enrollment - fp_day)/7, y = pmax(1, pt80))) +
  geom_line() +
  scale_y_log10() +
  geom_vline(aes(xintercept = (model_infection_day - fp_day)/7)) +
  geom_vline(aes(xintercept = (tpf_day - fp_day)/7), colour = "red") +
  facet_wrap(~pub_id) 


```

```{r}

titer_summary = pk_sim_pre_fp %>%
  filter(!is.na(model_infection_day)) %>%
  group_by(pub_id) %>%
  mutate(
    fp_vl = log10vl[first_positive],
    fp_pt80 = pt80[days_enrollment == fp_day],
    infection_pt80_pf = pt80[days_enrollment == tpf_day],
    infection_pt80_mod = pt80[days_enrollment == model_infection_day] 
    ) %>%
  distinct(pub_id, fp_vl, fp_pt80, infection_pt80_pf, infection_pt80_mod, gmt80ls, sens) 


titer_summary %>%
  ggplot(aes(x = pmax(1, fp_pt80), y = pmax(1,infection_pt80_mod))) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_abline() 


titer_summary %>%
  ggplot(aes(x = pmax(1, fp_pt80), y = pmax(1,infection_pt80_pf))) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_abline() +
  facet_wrap(~sens)

```


```{r}

titer_summary %>%
  mutate(lower_infection_titer = infection_pt80_pf < fp_pt80)
  ggplot(aes(x = pmax(1, fp_pt80), y = pmax(1,infection_pt80_pf))) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  geom_abline()

```

```{r}

ggplot(vl_mod_vrc01, aes(x = (fp_day - final_infusion_pre_fp_day)/7, y = first_pos)) +
  geom_point() +
  labs(y = "first pos VL", x = "Weeks btw first positive and previous infusion")


ggplot(vl_mod_vrc01, aes(x = (tpf_day - final_infusion_pre_fp_day)/7, y = first_pos)) +
  geom_point() +
  labs(y = "first pos VL", x = "Weeks btw pred. acquisition (PF) and final infusion (pre-fp)")


ggplot(vl_mod_vrc01, aes(x = (model_infection_day - final_infusion_pre_fp_day)/7, y = first_pos)) +
  geom_point() +
  labs(y = "first pos VL", x = "Weeks btw pred. acquisition (PKPD-V) and final infusion (pre-fp, negative VL)")

```

```{r}



```

<!-------
THE BELOW COULD BE USEFUL TO SET PLACEBO BOUNDARIES

## Predicted placebo titers 

Concentration data distributions come from the treatment population (see above). We consider two pre-infection concentration distributions below: predicted concentrations at time of infection and mean concentrations across participants.

To determine "placebo" titers, we use a "bootstrap" procedure. For each placebo ptid, we use their individual IC50 and IC80s to determine two measures of titer. The first is the distribution of titers calculated over the distribution of predicted concentrations at time of infection in the treatment population (Infection titer). The second is the distribution of titers calculated over the distribution of mean concentrations (prior to infection) in the treatment population (Mean titer). For each participant, these distributions are summarized by their range and their median.

This procedure is repeated on the treatment population (Bootstrap treatment). Specifically, we de-couple the PK data from the given participant as an assessment of the method, and then compare that to the actual titer calculations with the paired PK data (Actual treatment).


```{r placebo-setup}

neut_data = raw_neut %>% mutate(trt = pub_id %in% concentration_data$pub_id)
#placebo_neuts = dplyr::filter(neut_data, !trt)

bootstrap_titer = 
  map_df(unique(trt_titer$time), function(i){
    map_df(unique(neut_data$pub_id), function(j){

      neut_data %>%
        dplyr::select(-contains("cat")) %>%
        dplyr::filter(pub_id == j) %>% 
        gather("name", "value", gmt50ms, gmt50ls, gmt50mf, gmt80ms, gmt80ls, gmt80mf) %>%
        mutate(
          time = i,
          cat = if_else(str_detect(name, "50"), "ID50", "ID80"),
          min_titer = min(concentration_data[[i]]) / value,
          mean_titer = mean(concentration_data[[i]]) / value,
          median_titer = median(concentration_data[[i]]) / value,
          max_titer = max(concentration_data[[i]]) / value
        )
    })
})

```


### Range of bootstrap titer calculations in placebo

These plots are complicated.

```{r}

bootstrap_titer %>%
  dplyr::filter(!trt & time == "infection_time") %>%
  ggplot(aes(x = pub_id, y = median_titer, ymin = median_titer, ymax = max_titer)) +
  geom_pointrange() +
  coord_flip() +
  scale_y_log10("'bootstrap' median infection titer through max titer") +
  facet_wrap(~ cat + name, nrow = 2, scales="free_x") +
  labs(x = "Placebo participants") +
  theme(axis.text.y = element_blank())


```

```{r}

bootstrap_titer %>%
  dplyr::filter(!trt & time == "mean") %>%
  ggplot(aes(x = pub_id, y = median_titer, ymin = median_titer, ymax = max_titer)) +
  geom_pointrange() +
  coord_flip() +
  scale_y_log10("'bootstrap' median mean titer through max titer") +
  facet_wrap(~ cat + name, nrow = 2, scales="free_x") +
  labs(x = "Placebo participants") +
  theme(axis.text.y = element_blank())


```



### Predicted placebo titers vs. treatment


```{r placebo-trt-inf-titer}

trt_titer %>%
  rename(median_titer = titer) %>%
  mutate(trt = 2) %>%
  bind_rows(bootstrap_titer) %>%
  dplyr::filter(time == "infection_time") %>%
  mutate(
    grp = factor(trt, levels = 0:2,
                 labels = c("Bootstrap\nplacebo",
                            "Bootstrap\ntreatment",
                            "Actual\ntreatment")
    )
  ) %>%
  ggplot(aes(x = grp, y = median_titer)) +
  geom_boxplot() +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(aes(group = interaction(pub_id, name, cat)), alpha = 0.25) +
  scale_y_log10("Infection titer (bootstrap median)") +
  facet_wrap(~ cat + name, nrow = 2, scales="free_x")


```

```{r placebo-trt-inf-titer-dens, eval = F}

trt_titer %>%
  rename(median_titer = titer) %>%
  mutate(trt = 2) %>%
  bind_rows(bootstrap_titer) %>%
  dplyr::filter(time == "infection_time") %>%
  mutate(
    grp = factor(trt, levels = 0:2,
                 labels = c("Bootstrap\nplacebo",
                            "Bootstrap\ntreatment",
                            "Actual\ntreatment")
    )
  ) %>%
  ggplot(aes(x = median_titer, colour = grp)) +
  geom_density(bw = 0.5) +
  scale_x_log10("Infection titer (bootstrap median)") +
  facet_wrap(~ cat + name, nrow = 2, scales="free_x")


```

```{r placebo-trt-mean-titer}

trt_titer %>%
  rename(median_titer = titer) %>%
  mutate(trt = 2) %>%
  bind_rows(bootstrap_titer) %>%
  dplyr::filter(time == "mean") %>%
  mutate(
    grp = factor(trt, levels = 0:2,
                 labels = c("Bootstrap\nplacebo",
                            "Bootstrap\ntreatment",
                            "Actual\ntreatment")
    )
  ) %>%
  ggplot(aes(x = grp, y = median_titer)) +
  geom_boxplot() +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_line(aes(group = interaction(pub_id, name, cat)), alpha = 0.25) +
  scale_y_log10("Mean titer (bootstrap median)") +
  facet_wrap(~ cat + name, nrow = 2, scales="free_x")


```

##  Titer vs. viral load parms
---->