---
title: "Statistical analysis of VL data"
author: "Bryan Mayer"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
---

```{r load-packages, echo = FALSE, message=F,output=F}
knitr::opts_chunk$set(echo = F)
library(VISCfunctions)
library(tidyverse)
library(here)
library(glue)
library(kableExtra)
library(GGally)
library(cowplot)
theme_set(theme_bw() + theme(legend.position = "top", panel.grid.minor = element_blank()))

source(here("R", "directory-funs.R"))

#stopifnot(dir.exists("/Volumes/trials/"))

vl_lims = c(1, 7)
ic_cats = c("< 1 mcg/mL", "1-3 mcg/mL", "> 3 mcg/mL")
vl_title = expression(paste("Viral load (log"[10], " copies/mL)"))
ep_labels = tibble(
  levels = c("fp", "peak", "nadir", "mean"),
  label = c("First positive", "Peak", "Nadir", "Mean")
)

rx_lab = tibble(
  rx_code2 = c("C", "T1", "T2"),
  trt_cat = c("Placebo", "VRC01 (10mg/kg)", "VRC01 (30mg/kg)")
)

```


```{r load-data}

# note there is more upstream processing to clean the original data
vl_data = read_csv(mlx_data_here("clean_source/adata_vl_data.csv"), col_types = cols())

```


## Background

This document contains the statistic analysis of the viral load data of AMP breakthrough infections among participants with infection diagnosed by week 80.

### Sample size and censoring

There are 220 participants with viral load data. Of these, 46 were diagnosed > 80 weeks following enrollment. Of the remaining participants, only 162 have neutralization data. This comprises the primary analysis data set. 

Additional exclusions were included based on further evaluation. Two infected participants (one placebo, one treated) have no positive viral load measurements and were excluded. Final viral load measurements were included for analysis from first positive time through the final measurement time prior to ART initiation and/or end of followup.

```{r overall-sample-size}

measurement_summary = vl_data %>%
  filter(days_dx >= 0 & infection_pre80wks & has_neut_data) %>%
  group_by(pub_id, has_neut_data, rx_code2, protocol) %>%
  summarize(
    peak_vl = max(vl_num),
    peak_vl_no_art = max(vl_num[on_art == 0]),
    total_measurements = n(),
    total_measurements_pos = length(vl[cens != 1]),
    total_pos_offart = length(vl[on_art == 0 & cens != 1]),
    total_pos_onart = n() - total_measurements_pos
  , .groups = "drop") %>%
  gather(key, total, -pub_id, -peak_vl, -peak_vl_no_art, -has_neut_data, -rx_code2, -protocol) 

measurement_summary %>%
  dplyr::filter(key %in% c("total_pos_offart", "total_measurements")) %>%
  mutate(total_pos_vl = pmin(total, 5)) %>%
  group_by(key, total_pos_vl) %>%
  summarize(
    total_ptids = n()
    , .groups = "drop") %>%
  arrange(total_pos_vl) %>%
  mutate(total_pos_vl = if_else(total_pos_vl < 5, as.character(total_pos_vl), "> 4")) %>%
  pivot_wider(names_from = key, values_from = total_ptids, values_fill = 0) %>%
  rename(`Total positive VL` = total_pos_vl, `N (pre-ART)` = total_pos_offart, `N` = total_measurements) %>%
  kable(caption = "Sample sizes for total detectable VL") %>% kable_styling(full_width = F)

measurement_summary %>%
  dplyr::filter(key %in% c("total_pos_offart", "total_measurements")) %>%
  mutate(total_pos_vl = pmin(total, 5)) %>%
  group_by(key, rx_code2, total_pos_vl) %>%
  summarize(
    total_ptids = n()
    , .groups = "drop") %>%
  arrange(rx_code2, total_pos_vl) %>%
  mutate(total_pos_vl = if_else(total_pos_vl < 5, as.character(total_pos_vl), "> 4")) %>%
  pivot_wider(names_from = key, values_from = total_ptids, values_fill = 0) %>%
  rename(`Group` = rx_code2, `Total positive VL` = total_pos_vl, `N (pre-ART)` = total_pos_offart, `N` = total_measurements) %>%
  kable(caption = "Sample sizes for total detectable VL") %>% kable_styling(full_width = F)

low_sample_ptids = measurement_summary %>%
  dplyr::filter(key == "total_pos_offart" & total < 1) %>%
  pull(pub_id)

measurement_summary %>%
  dplyr::filter(key %in% c("total_pos_offart") & !pub_id %in% low_sample_ptids) %>%
  group_by(key, rx_code2, protocol) %>%
  summarize(
    total_ptids = n()
    , .groups = "drop") %>%
  mutate(rx_code2 = factor(rx_code2, levels = rx_lab$rx_code2, labels = rx_lab$trt_cat)) %>%
   pivot_wider(names_from = protocol, values_from = total_ptids, values_fill = 0) %>%
  dplyr::select(-key, RX = rx_code2) %>%
  kable(caption = "Sample sizes") %>% kable_styling(full_width = F)

```


```{r final-adata}

vl_data_analysis_full = vl_data %>%
  dplyr::filter(!pub_id %in% low_sample_ptids & on_art == 0 & has_neut_data) %>%
  left_join(dplyr::select(neut_data, -contains("cat")), by = "pub_id") %>%
  mutate(log10VL = log10(vl_num),
         rx_lab = factor(rx_code2, levels = rx_lab$rx_code2, labels = rx_lab$trt_cat))

 write_csv(dplyr::select(vl_data_analysis_full, -flag, -has_neut_data, -infection_pre80wks, -rx),
                         "/Volumes/trials/vaccine/Bryan_Mayer/AMP-Modeling/data/amp-vl-neut-all.csv")

vl_data_analysis = vl_data_analysis_full %>%
  dplyr::filter(days_fp >= 0) %>%
  mutate(ic80ls_cat = factor(if_else(gmt80ls < 1, 0, 1),
                           levels = 0:1,
                           labels = c(expression(paste("IC80 < 1 mcg/mL")), 
                                      expression(paste("IC80" >= "1 mcg/mL")))))
  
neut_data_long = neut_data %>%
  dplyr::select(-contains("cat")) %>%
  gather("key", "value", -pub_id, -nisolates) %>%
  mutate(key = str_replace_all(key, "0", "0_")) %>%
  separate(key, into = c("titer", "isolate"), sep = "_") %>%
  pivot_wider(names_from = "titer", values_from = "value")


kinetics_summary = vl_data_analysis %>%
  group_by(pub_id, rx_lab, protocol, nisolates, across(contains("gmt"))) %>%
  nest() %>%
  summarize(
    peak = map(data, ~tibble(days_fp = .$days_fp[which.max(.$log10VL)],
                             log10VL = .$log10VL[which.max(.$log10VL)])),
    nadir = map(data, ~tibble(days_fp = .$days_fp[which.min(.$log10VL)],
                             log10VL = .$log10VL[which.min(.$log10VL)])),
    fp = map(data, ~tibble(days_fp = 0,
                             log10VL = .$log10VL[.$days_fp == 0])),
    mean = map(data, ~tibble(days_fp = NA_real_,
                             log10VL = mean(.$log10VL)))
    ,`.groups` = "drop") %>%
  pivot_longer(names_to = "endpoint", values_to = "tib", c(peak, nadir, fp, mean)) %>%
  unnest(c(tib)) %>%
  mutate(endpoint_plot = factor(endpoint, levels = ep_labels$levels, labels = ep_labels$label))
  

censored_pub = subset(vl_data_analysis, cens == 1) %>%
  distinct(pub_id) %>% pull(pub_id)

```


## Exploratory data analysis 

### Longitudinal

```{r vl-scatter-peak, fig.height=7,fig.width=6.5}

ggplot(vl_data_analysis, aes(x = days_fp, y = log10VL, group = pub_id, colour = rx_lab)) +
  geom_line(alpha = 0.5) +
  geom_point(data = dplyr::filter(kinetics_summary, endpoint == "peak"), alpha  = 0.75) +
  scale_y_continuous(breaks = 2:7) +
  labs(color = "", x = "Days post first positive", y = vl_title) +
  facet_wrap(~protocol, nrow = 2) 


```


```{r vl-scatter-groups}

ggplot(vl_data_analysis, aes(x = days_fp, y = log10VL, group = pub_id, colour = rx_lab)) +
  geom_line(alpha = 0.5) +
  #geom_point(data = dplyr::filter(kinetics_summary, endpoint == "peak"), alpha  = 0.75) +
  scale_y_continuous(breaks = 2:7) +
  labs(color = "", x = "Days post first positive", y = vl_title) +
  facet_wrap(~ic80ls_cat+rx_lab, nrow = 2, labeller = labeller(ic80ls_cat = label_parsed)) +
  theme(legend.position = "none")


```


```{r vl-time-peak}

kinetics_summary %>% 
  dplyr::filter(endpoint == "peak") %>%
  ggplot(aes(x = days_fp, y = log10VL, colour = rx_lab)) +
  geom_point(alpha  = 0.5) +
  scale_y_continuous(limits = vl_lims, breaks = 1:7) +
  labs(color = "", x = "Days post first positive", y = "Peak log10VL") +
  facet_wrap(~protocol, nrow = 2)

```

```{r vl-time-nadir}

kinetics_summary %>%
  dplyr::filter(endpoint == "nadir") %>%
  ggplot(aes(x = days_fp, y = log10VL, colour = rx_lab)) +
  geom_point(alpha  = 0.5) +
  scale_y_continuous(limits = vl_lims, breaks = 1:7) +
  labs(color = "", x = "Days post first positive", y = "Nadir log10VL") +
  facet_wrap(~protocol, nrow = 2)

```

### Kinetic Summary

```{r kinetics-bp}

 bquote("IC80 >= 1 mcg/mL")

kinetics_summary %>%
  mutate(rx_lab2 = str_replace(rx_lab, " ", "\n"),
         ic80_cat = factor(if_else(gmt80ls < 1, 0, 1),
                           levels = 0:1,
                           labels = c(expression(paste("IC80 < 1 mcg/mL")), 
                                      expression(paste("IC80" >= "1 mcg/mL"))))
         )  %>%
  ggplot(aes(x = rx_lab2, y = log10VL, colour = rx_lab2)) +
  geom_boxplot(width = 0.3) +
  scale_y_continuous(breaks = 2:7) +
  geom_point()+
  facet_grid(cols = vars(ic80_cat), rows = vars(endpoint_plot), switch = "y", labeller = labeller(ic80_cat = label_parsed)) +
  labs(y = vl_title, x = "") +
  theme(strip.placement = "outside", strip.background = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(size = 9)) 

```

### Neutralization summary

The IC50 and IC80 data is very well correlated within isolate class (most frequent, most sensitive, least sensitive). And generally in agreement in resistance category. Two outliers standout because the IC80 suggests resistance while the IC50 suggests none.

Using an orthogonal regression, the IC50 and IC80 data track well together. The intercept of 3.3-fold shift between IC50 and IC80 suggest that the IC50 and IC80 are closer together than a Hill-slope of 1 (which would correspond to 4-fold change). The slope of 1 (if IC50 goes up x-fold, then IC80 goes up x-fold) implies that the hill slope is conserved over the range of sensitive viruses in these data. 

```{r}

denning_reg = function(formula, dat){
  pca <- prcomp(formula, dat)
  tibble(slp = with(pca, rotation[2,1] / rotation[1,1]),
         int = with(pca, center[2] - slp*center[1])
  )
}

pls = map(c("ms", "mf", "ls"), function(i){
  tmp_dat = neut_data_long %>%
    dplyr::filter(isolate == i & gmt80 < 100) %>%
    mutate(log10gmt50 = log10(gmt50), log10gmt80 = log10(gmt80))
  
  den_lm = denning_reg(~log10gmt50 + log10gmt80, tmp_dat)
  
  ggplot(data = tmp_dat, aes(x = log10gmt50, y = log10gmt80)) + 
    annotate("rect", xmin = -Inf, xmax = Inf, ymin = log10(3), ymax = Inf, fill = "red", alpha = 0.5) +
    annotate("rect", xmin = log10(3/3.33), xmax = Inf, ymin = -Inf, ymax = Inf, fill = "red", alpha = 0.5) +
    annotate("rect", xmin = -Inf, xmax = log10(1/3.33), ymin = -Inf, ymax = log10(1), fill = "blue", alpha = 0.5) +
    #geom_smooth(method = "lm", se=FALSE, color="black", formula = y ~ x) +  
    geom_point() +
    geom_abline(slope=den_lm$slp, intercept=den_lm$int, color="blue") +
    annotate("text", x = -0.5, y = 1.75, label = paste0('slp=', round(den_lm$slp,2),
                                                      "; ratio=", round(10^den_lm$int,2))) +
    geom_hline(yintercept = log10(c(1, 3)), linetype = "dashed") +
    ggtitle(i) #+
    #annotate("text", x = 1, y = 200, label = linear(lm(fo, tmp_dat)), 
    #                      colour="black", size = 3, parse=TRUE)
  
})

plot_grid(plotlist = pls)
 
```

```{r}


vl_data_analysis %>%
  dplyr::select(contains("gmt"), nisolates) %>%
  dplyr::filter(nisolates > 1) %>%
  ggpairs(columns = 1:6, mapping = ggplot2::aes(colour=factor(nisolates)))
  
  
```


## Supplementary figures

```{r vl-scatter-cens}

vl_data_analysis %>%
  dplyr::filter(pub_id %in% censored_pub) %>%
  ggplot(aes(x = days_fp, y = log10VL, group = pub_id, colour = rx_lab)) +
  geom_line(alpha = 0.5) +
  geom_point(alpha  = 0.5) +
  scale_y_continuous(limits = vl_lims, breaks = 1:7) +
  facet_wrap(~protocol, nrow = 2)

```

```{r kinetics-protocol-bp}

kinetics_summary %>%
  mutate(rx_lab2 = str_replace(rx_lab, " ", "\n")) %>%
  ggplot(aes(x = rx_lab2, y = log10VL, colour = rx_lab2)) +
  geom_boxplot(width = 0.3) +
  scale_y_continuous(breaks = 2:7) +
  geom_point()+
  facet_grid(cols = vars(protocol), rows = vars(endpoint_plot), switch = "y") +
  labs(y = vl_title, x = "") +
  theme(strip.placement = "outside", strip.background = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(size = 9)) 

```

