---
title: "Simulate PK Data"
author: "Bryan Mayer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

PK parameters fit based on case-control data (all infusions prior to first positive RNA).

Two simulations performed here:

1. "Case-Control": PK through first positive
2. "AMP PK": PK through end of study

Both datasets will have key times merged on for easier filter to concentrations at those times.



```{r load-packages, echo = FALSE, message=F,output=F}
knitr::opts_chunk$set(echo = F)
library(VISCfunctions)
library(tidyverse)
library(here)
library(glue)
library(kableExtra)
library(lixoftConnectors)
library(RxODE)

theme_set(theme_bw() + theme(legend.position = "top"))

options(scipen = 999)

initializeLixoftConnectors(software = "monolix")

rx_lab = tibble(
  rx_code2 = c("C", "T1", "T2"),
  trt_cat = c("Placebo", "VRC01 (10mg/kg)", "VRC01 (30mg/kg)")
)

save_shared_folder = F

```


```{r load-funs-data}

source(here("R", "directory-funs.R"))
source(here("R", "mlx-model-funs.R"))
source(here("R", "fix-parm-funs.R"))
source(here("R", "mlx-res-processing.R"))

rx_dat = read_csv(raw_data_here("rx_dat.csv"), col_types = cols())

pk_data_nm = read_csv(mlx_data_here("pk-nm-data.csv"), col_types = cols())
median_weight = pk_data_nm %>% distinct(pub_id, weight) %>% summarize(median(weight)) %>% pull()
pk_data_analysis = read_csv(clean_data_here("adata-pk.csv"), col_types = cols())
analysis_ptids = unique(pk_data_analysis$pub_id)

vl_data_analysis = read_csv(clean_data_here("adata-vl-stats.csv"), col_types = cols())

neut_data = read_csv(clean_data_here("amp-neut-blinded.csv"), col_types = cols())

pk_dir_tag = function(x) paste0("PK/", x)
pk_model_here = function(x, ...) mlx_model_here(pk_dir_tag(x), ...)
```



# Explore PK

```{r}
loadProject(mlx_model_here(pk_dir_tag("VRC01AMP_Case-Cntrl"), mlxtran = T))

```

## Setup

```{r load-pk-res}

# getIndividualParameterModel()$formula
# log(Cl) = log(Cl_pop) + beta_Cl_tWT*tWT + beta_Cl_study_1*[study = 1]
# log(V2) = log(V2_pop) + beta_V2_study_1*[study = 1]

time_data = read_csv(clean_data_here("ptid-time-data.csv"), col_types = cols())
pop_ests = get_pop_ests(pk_dir_tag("VRC01AMP_Case-Cntrl"))

pop_wide = spread(pop_ests, key = parameter, value = value)

indiv_parms_no_followup = pk_data_analysis %>%
  dplyr::filter(no_followup) %>%
  transmute(
    pub_id = pub_id,
    Cl = exp(log(pop_wide$Cl_pop) + pop_wide$beta_Cl_tWT*log(weight/67.3) + pop_wide$beta_Cl_study_1*(study == 1)),
    V1 = pop_wide$V1_pop,
    Q = pop_wide$Q_pop,
    V2 = exp(log(pop_wide$V2_pop) + pop_wide$beta_V2_study_1 * (study == 1)),
    est_method = 'population - missing followup' 
  )

indiv_parms_mode = get_indiv_parms(pk_dir_tag("VRC01AMP_Case-Cntrl")) %>%
  dplyr::select(pub_id = id, contains("_mode")) %>%
  rename_with(~str_replace(., "_mode", "")) %>%
  dplyr::filter(pub_id %in% analysis_ptids) %>%
  mutate(est_method = 'mode') %>%
  bind_rows(indiv_parms_no_followup) %>%
  left_join(rx_dat, by = "pub_id") %>%
  mutate(rx_lab = factor(rx_code2, levels = rx_lab$rx_code2, labels = rx_lab$trt_cat)) %>%
  dplyr::select(-rx) %>%
  write_csv(here("output/pk-modeling", "pk-mode-parms.csv"))
 stopifnot(n_distinct(indiv_parms_mode$pub_id) == 96)

indiv_fits = get_indiv_fits(pk_dir_tag("VRC01AMP_Case-Cntrl")) %>% rename(pub_id = ID) %>%
  dplyr::filter(pub_id %in% analysis_ptids) 

indiv_preds = get_indiv_preds(pk_dir_tag("VRC01AMP_Case-Cntrl")) %>% rename(pub_id = ID) %>%
  dplyr::filter(pub_id %in% analysis_ptids)

# the 15 people with no concentration data,  of course are missing

missing_ptids_parms = setdiff(analysis_ptids, unique(indiv_parms_mode$pub_id))
n_distinct(missing_ptids_parms)

missing_ptids_fits = setdiff(analysis_ptids, unique(indiv_fits$pub_id))
n_distinct(missing_ptids_fits)

missing_ptids_preds = setdiff(analysis_ptids, unique(indiv_preds$pub_id))
n_distinct(missing_ptids_preds)
```

## Fits - mlx

```{r, fits}

#| fig.width=12, fig.height=12

pk_fits = ggplot(indiv_fits, aes(x = time/7, y = pmax(0.03, indivPredMode))) +
  geom_line() +
  geom_point(data = indiv_preds, aes(y = DV)) +
  scale_y_log10() +
  facet_wrap( ~ pub_id, nrow = 9, ncol = 9) +
  geom_vline(data = dplyr::filter(time_data, pub_id %in% unique(indiv_fits$pub_id)), 
             aes(xintercept = tpf_day/7), colour = "red", linetype = 'dashed') +
  geom_vline(data = dplyr::filter(time_data, pub_id %in% unique(indiv_fits$pub_id)), 
             aes(xintercept = fp_day/7), colour = "red") +
  labs(y = "[VRC01]") +
  theme(legend.position = 'top') +
  labs(x = "weeks") +
  ggtitle("dashed = PF-infection time. solid = first positive")

pk_fits

ggsave(here("output/pk-modeling/pk_fits.pdf"), pk_fits, width = 12, height = 12)

```

## Fits - RxODE

```{r fit-nlmixr-setup}

dose_data = pk_data_nm %>%
  dplyr::filter(DV == "." & AMT != ".") %>%
  mutate(across(c(AMT, RATE), as.numeric)) %>%
  select(pub_id, TIME, AMT, RATE, DOSENO)

pk_2cmpt <- RxODE({
  kel = Cl/V1
  k12 = Q/V1
  k21 = Q/V2

  d/dt(centr) = -(k12+kel)*centr + k21 * peri
  d/dt(peri) = k12*centr - k21*peri
  
  Cc = centr/V1
  Pc = peri/V2
})

sim_pk <- function(final_day,
                   parms,
                   dose_info,
                   key_times = NULL,
                   output_grid_by = 1) {
  
  sim_times = c(seq(0, final_day, by = output_grid_by), key_times) %>%
    sort() %>%
    unique()


  ev = eventTable(time.units = "days") %>%
    add.sampling(sim_times) 
  
  for(i in dose_info$DOSENO){
    dose_iteration = dplyr::filter(dose_info, DOSENO == i)
    ev = ev %>%
      add.dosing(
      dose = dose_iteration$AMT,
      rate = dose_iteration$RATE,
      nbr.doses = 1,
      cmt = "centr",
      start.time = dose_iteration$TIME
      )
  }

  as_tibble(rxSolve(pk_2cmpt, params = parms, event = ev)) %>% 
    mutate(days_enrollment = as.numeric(time)) %>%
    dplyr::select(-time)

}

```


```{r test-dat-setup, eval = F}
test_pub_id = "704-0662"
test_set = subset(indiv_parms_mode, pub_id == test_pub_id) %>%
  select(where(is.numeric))
test_dose = subset(dose_data, pub_id == test_pub_id) 
vl_times = subset(time_data, pub_id == test_pub_id)

x = sim_pk(vl_times$final_vl_day, test_set, dose_info = test_dose, 
           key_times = c(subset(indiv_preds, pub_id == test_pub_id)$time,
                         subset(indiv_fits, pub_id == test_pub_id)$time,
                         vl_times$fp_day, vl_times$tpf_day, vl_times$dx_day)) %>%
  mutate(pub_id = test_pub_id)


ggplot(data = x, aes(x = days_enrollment/7, y = Cc)) +
  geom_line() +
  geom_line(data = subset(indiv_fits, pub_id == test_pub_id), aes(x = time/7, y = indivPredMode), colour = "red") +
  scale_y_log10(limits = c(0.1, NA)) +
  geom_vline(data = vl_times, aes(xintercept = fp_day/7)) 


subset(indiv_preds, pub_id == test_pub_id) %>%
  dplyr::select(pub_id, time, DV, indivPredMode) %>%
  left_join(dplyr::select(indiv_fits, pub_id, time, indivPredMode), by = c("pub_id", "time")) %>%
  left_join(dplyr::select(x, pub_id, time = days_enrollment, Cc), by = c("pub_id", "time")) 

```

```{r sim-pk}


sim_pk_dat = map_df(unique(subset(indiv_parms_mode, !is.na(Cl))$pub_id), function(i){
  
  # relevent data
  parms = dplyr::select(subset(indiv_parms_mode, pub_id == i), Cl, V1, Q, V2)
  dosing = subset(dose_data, pub_id == i) 
  vl_data = dplyr::select(subset(vl_data_analysis, pub_id == i & days_enrollment >= fp_day), 
                          pub_id, days_enrollment, cens, vl, log10vl)
  vl_data_times = vl_data$days_enrollment
  vl_times = subset(time_data, pub_id == i)
  obs_data = dplyr::select(subset(indiv_preds, pub_id == i), pub_id, time, obs_conc = DV)
  
  final_time = vl_times$final_vl_day
  extra_pk_vl_times = c(obs_data$time,
               subset(indiv_fits, pub_id == i)$time,
               vl_data_times, 
               vl_times$tpf_day
  )
               
  sim_pk(
    vl_times$final_vl_day,
    parms = parms,
    dose_info = dosing,
    key_times = extra_pk_vl_times
  ) %>%
    mutate(pub_id = i) %>%
    dplyr::select(pub_id, days_enrollment, centr_conc = Cc, peri_conc = Pc) %>%
    left_join(indiv_parms_mode, by = "pub_id") %>%
    left_join(obs_data, by = c("pub_id", "days_enrollment" = "time")) %>%
    left_join(vl_data, by = c("pub_id", "days_enrollment")) %>%
    mutate(
      tpf_day = vl_times$tpf_day,
      fp_day =  vl_times$fp_day,
      dx_day = vl_times$dx_day,
      post_fp = days_enrollment >= fp_day,
      vl_detected = !is.na(vl),
    ) 
  
})

any(is.na(sim_pk_dat$centr_conc))
any(is.na(sim_pk_dat$peri_conc))

```


```{r fits-rxode}

#| fig.width=12, fig.height=12

pk_fits_ode = ggplot(sim_pk_dat, aes(x = days_enrollment/7, y = pmax(0.03, centr_conc))) +
  geom_line() +
  geom_point(aes(y = obs_conc)) +
  scale_y_log10() +
  facet_wrap( ~ pub_id, nrow = 10, ncol = 10) +
  geom_vline(aes(xintercept = tpf_day/7), colour = "red", linetype = 'dashed') +
  geom_vline(aes(xintercept = fp_day/7), colour = "red") +
  labs(y = "[VRC01]") +
  theme(legend.position = 'top') +
  labs(x = "weeks") +
  ggtitle("dashed = PF-infection time. solid = first positive")

pk_fits_ode

ggsave(here("output/pk-modeling/pk_fits_ode.pdf"), pk_fits_ode, width = 12, height = 12)

```

## Save key output

Merge on neut data for full time series PKPD with viral load.

Also filter to infection data alone.

```{r save-pk-sims}

sim_pk_dat_neut = sim_pk_dat %>%
  left_join(dplyr::select(neut_data, -contains("cat")) , by = "pub_id") %>%
  write_csv(here("output/pk-modeling/pk-sims-vl-neut.csv"))

infection_day_conc = sim_pk_dat_neut %>%
  dplyr::filter(abs(days_enrollment - tpf_day) <1e-6) %>%
  dplyr::select(pub_id, days_enrollment, centr_conc, peri_conc, tpf_day, fp_day, contains("rx"), contains("gmt")) %>%
   write_csv(here("output/pk-modeling/infection-day-pkpd.csv"))

n_distinct(infection_day_conc)
infection_day_conc %>% group_by(pub_id) %>% summarize(total = n()) %>% filter(total != 1)

```


```{r}
read_csv(here("output/pk-modeling/infection-day-pkpd-x.csv")) %>%
  dplyr::select(pub_id, centr_conc) %>%
  full_join(select(infection_day_conc, pub_id, centr_conc), by = "pub_id") ->x

```

```{r save-shared-pk, eval = save_shared_folder}
write_csv(sim_pk_dat_neut, "/Volumes/trials/vaccine/Bryan_Mayer/AMP-Modeling/data/sim-pk-withVLPD.csv")
write_csv(infection_day_conc, "/Volumes/trials/vaccine/Bryan_Mayer/AMP-Modeling/data/predicted-pk-infection-day.csv")
```
