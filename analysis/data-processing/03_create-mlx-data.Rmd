---
title: "Create mlx data"
author: "Bryan Mayer"
date: "4/21/2022"
output: html_document
---

```{r load-packages, echo = FALSE, message=F,output=F}

knitr::opts_chunk$set(echo = F)
library(VISCfunctions)
library(tidyverse)
library(here)
library(glue)
library(kableExtra)
library(patchwork)

theme_set(theme_bw() + theme(legend.position = "top"))

options(scipen = 999)

# plot cutoff
cutoff = 1.602060
cutoffexp = substitute(expression(NULL <= a), list(a = cutoff))

sum_nonmissing = function(x) sum(!is.na(x))
hill_slope = function(ic50, ic80) -log(4)/(log(ic50/ic80))

read_csv_quiet = function(...) read_csv(..., col_types = )

rbind_dose = function(vl_dat, dose_data, ptid_subset){
  vl_dat %>%
  bind_rows(dose_data) %>%
  dplyr::filter(pub_id %in% ptid_subset) %>%
  arrange(pub_id, TIME) %>%
  mutate(
    AMT = if_else(is.na(AMT), ".", as.character(AMT)),
    AMT_log = if_else(is.na(AMT_log), ".", as.character(AMT_log)),
    DV = if_else(is.na(DV), ".", as.character(DV)),
    DV_log = if_else(is.na(DV_log), ".", as.character(DV_log)),
    cens = if_else(is.na(cens), ".", as.character(cens)),
    limit = if_else(is.na(limit), ".", as.character(limit))
  )
}

```


```{r load-funs-data}

source(here("R", "directory-funs.R"))
```

# Creating MLX data

Monolix has some required specifications and variables it is expecting so this file generally creates datasets that meet those requirements. 

Some background:

- The PK data alone was previously processed by the HVTN for the case-control PK study: `data/processed-data/pk-nm-data.csv`
- The Holte Model analysis was performed by Dan separately, acting more as as spline to describe the VL data
- Key outputs to be used in the PKPD analysis:
  - Placebo AMP+RV217 data for training the VL model
  - VRC01 groups for PKPD: VL + PK dat 
- Key inputs for the PKPD analysis:
  - Data generated from `analysis/data-processing/02_data-processing`
    - processed vl data with neut data merged on: `data/processed-data/adata-vl.csv`
      - neut/demo data from here
    - processed pk data: `data/processed-data/adata-pk.csv`
      - contains some additional demo data
  - infection times generated by Dan from the Holte model (fit to the pooled data)

For the PKPD analysis, time is always relative to the enrollment date (days_enrollment). Infection time determines the "dosing" of viral load. Will use both the DxPF times and the Holte. Will need to be saved as separate datasets.
    
    
```{r load-data}
adata_vl = read_csv_quiet(clean_data_here("adata-vl.csv"))
adata_pk = read_csv_quiet(clean_data_here("adata-pk.csv"))
raw_nm_pk = read_csv_quiet(clean_data_here("pk-nm-data.csv"))
rv217 = read_csv_quiet(clean_data_here("rv217-vl.csv"))

infection_times = read_csv_quiet(clean_data_here("ptid-time-data.csv")) %>% dplyr::select(pub_id, tpf_day, fp_day) %>%
  left_join(dplyr::select(read_csv_quiet(here("output/vl-analysis/=")), pub_id = id, rel_holte_day = initT_mode), by = "pub_id") %>%
  mutate(holte_day = fp_day - rel_holte_day, rel_tpf_day = fp_day - tpf_day) %>%
  dplyr::filter(!is.na(tpf_day) & !is.na(holte_day))

demo_vl = dplyr::select(adata_vl, pub_id, country, contains("gmt"), nisolates, protocol, study, rx_code2) %>% distinct()
demo_pk = dplyr::distinct(raw_nm_pk, pub_id, weight)
all_demo = left_join(demo_vl, demo_pk, by = "pub_id")

final_placebo_ptids = unique(dplyr::filter(all_demo, rx_code2 == "C")$pub_id)
final_pkpd_ptids = unique(dplyr::filter(all_demo, rx_code2 != "C")$pub_id)

```


```{r inf-times}

ggplot(infection_times, aes(x = rel_holte_day, y = rel_tpf_day)) +
  geom_point() +
  ylab("Dx-PF infection days before first positive") +
  xlab("Holte model infections days before first positive") +
  theme(aspect.ratio=1)

ggplot(infection_times, aes(x = holte_day, y = tpf_day)) +
  geom_point() +
  ylab("Dx-PF infection day post-enrollment") +
  xlab("Holte model infection day post-enrollment") +
  theme(aspect.ratio=1)

```

```{r mlx-merge-setup}

pk_stem = dplyr::select(raw_nm_pk, pub_id, AMT, DV, RATE, TIME, dose) %>%
  dplyr::filter(pub_id %in% final_pkpd_ptids)

vl_stem = adata_vl %>%
  mutate(
    limit = if_else(cens == 1, "0", if_else(cens == -1, "1e9", "."))
    ) %>%
  dplyr::select(pub_id, TIME = days_enrollment, DV = vl, DV_log = log10vl, days_fp, tpf_est = fp_post_tpf, cens, limit)

with(all_demo, ftable(rx_code2))
glimpse(all_demo)
stopifnot(nrow(all_demo) == 158)
stopifnot(all(!is.na(select(all_demo, -weight)))) # weight comes from PK data, VRC01 only currently
stopifnot(length(final_placebo_ptids) == 62)
stopifnot(length(final_pkpd_ptids) == 43+53)

stopifnot(n_distinct(pk_stem$pub_id) == 43+53)

```

## Primary data

### Setup viral dose

```{r dose-setup}

viral_dose_data_holte = infection_times %>%
  dplyr::distinct(pub_id, TIME = holte_day) %>%
  mutate(
    TIME = floor(TIME), # just to keep round numbers
    AMT = 0.01/1e3,
    AMT_log = log10(AMT)
    )

viral_dose_data_dxpf = infection_times %>%
  dplyr::distinct(pub_id, TIME = tpf_day) %>%
  mutate(
    AMT = 0.01/1e3,
    AMT_log = log10(AMT)
    )

viral_dose_data_rv217 = xxx %>%
  dplyr::distinct(pub_id, TIME = holte_day) %>%
  mutate(
    AMT = 0.01/1e3,
    AMT_log = log10(AMT)
    )

glimpse(viral_dose_data_holte)
glimpse(viral_dose_data_dxpf)
glimpse(viral_dose_data_rv217)

```

### Full VL set

TBD? VL data for all groups. Would be used for fitting Holte model. Done separately by Dan currently.

```{r mlx-vl-all. eval = F}

amp_vl_all = vl_stem %>%
  left_join(all_demo, by = "pub_id") %>%
stopifnot(n_distinct(amp_vl_all$pub_id) == 151)
stopifnot(all(!is.na(amp_vl_all)))

write_csv(amp_vl_all, mlx_data_here("amp-vl-all.csv"))

```

### Placebos

```{r mlx-placebo}

placebo_vl = vl_stem %>%
  dplyr::filter(pub_id %in% final_placebo_ptids) %>%
  left_join(all_demo, by = "pub_id") %>%
  dplyr::select(-weight)

stopifnot(n_distinct(placebo_vl$pub_id) == 62)
stopifnot(all(!is.na(placebo_vl)))

# don't save rn, do we need this version of the data?
# placebo_vl %>%
#   write_csv(mlx_data_here("amp-vl-placebo.csv"))

amp_dosevl_placebo_holte = rbind_dose(dplyr::select(vl_stem, -days_fp, -tpf_est), viral_dose_data_holte, final_placebo_ptids) %>%
  left_join(all_demo, by = "pub_id") %>%
  dplyr::select(-weight)

amp_dosevl_placebo_dxpf = rbind_dose(dplyr::select(vl_stem, -days_fp, -tpf_est), viral_dose_data_dxpf, final_placebo_ptids) %>%
  left_join(all_demo, by = "pub_id") %>%
  dplyr::select(-weight)

stopifnot(n_distinct(amp_dosevl_placebo_holte$pub_id) == 62)
stopifnot(all(!is.na(amp_dosevl_placebo_holte)))
stopifnot(all(amp_dosevl_placebo_holte$rx_code2 == "C"))

stopifnot(n_distinct(amp_dosevl_placebo_dxpf$pub_id) == 62)
stopifnot(all(!is.na(amp_dosevl_placebo_dxpf)))
stopifnot(all(amp_dosevl_placebo_dxpf$rx_code2 == "C"))

```


```{r rv217-data}

rv217_dose = rbind_dose(rv217, viral_dose_data_rv217, unique(rv217$pub_id)) %>%
  mutate(protocol = "RV217")

```


```{r combine-placebo-rv217}

amp_dosevl_placebo_holte %>%
  dplyr::select(-country, -nisolates, -contains("gmt"), -study, -rx_code2) %>%
  bind_rows(rv217_dose) %>%
  write_csv(mlx_data_here("ampPlaceboHoltet0-rv217-vldose.csv"))

```

### VRC01 groups

```{r bind-pk-fun}

bind_pk = function(vl_dat, pk_dat){
  vl_dat %>%
    bind_rows(mutate(pk_dat, DVID = 1, cens = "0", limit = ".")) %>%
    dplyr::select(-dose) %>%
    mutate(
      ADM = if_else(DVID == 1 & AMT != ".", "1",
                    if_else(DVID == 2 & AMT != ".", "2", ".")),
      RATE = if_else(is.na(RATE), ".", RATE),
      AMT_log = if_else(is.na(AMT_log) & DVID == 1, AMT, AMT_log),
      DV_log = if_else(is.na(DV_log) & DVID == 1, DV, DV_log)
    ) 
}

```

```{r trt-vl}

amp_dosevl_trt_holte = rbind_dose(dplyr::select(vl_stem, -days_fp, -tpf_est), viral_dose_data_holte, final_pkpd_ptids) %>%
  mutate(DVID = 2)

amp_dosevl_trt_dxpf = rbind_dose(dplyr::select(vl_stem, -days_fp, -tpf_est), viral_dose_data_dxpf, final_pkpd_ptids) %>%
  mutate(DVID = 2)

stopifnot(n_distinct(amp_dosevl_trt_holte$pub_id) == 43+53)
stopifnot(all(!is.na(amp_dosevl_trt_holte)))

stopifnot(n_distinct(amp_dosevl_trt_dxpf$pub_id) == 43+53)
stopifnot(all(!is.na(amp_dosevl_trt_dxpf)))

```

```{r amp-pkpd}

pkpd_dat_holte = amp_dosevl_trt_holte %>%
  bind_pk(pk_stem) %>%
  left_join(all_demo, by = "pub_id")

pkpd_dat_dxpf = amp_dosevl_trt_dxpf %>%
  bind_pk(pk_stem) %>%
  left_join(all_demo, by = "pub_id")

stopifnot(n_distinct(pkpd_dat_holte$pub_id) == 43+53)
stopifnot(all(!is.na(pkpd_dat_holte)))

stopifnot(n_distinct(pkpd_dat_dxpf$pub_id) == 43+53)
stopifnot(all(!is.na(pkpd_dat_dxpf)))

write_csv(pkpd_dat_holte, mlx_data_here("amp-pkpd-Holtet0.csv"))
```

